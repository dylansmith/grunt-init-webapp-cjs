module.exports = function(grunt) {
    'use strict';

    var path = require('path'),
        Handlebars = require('handlebars');

    function bundler(src, dest, glob) {
        var rel, matches = [];

        src = path.resolve(src);
        dest = path.resolve(dest);
        rel = path.relative(path.dirname(dest), src);

        grunt.file.expand({cwd: src}, glob).forEach(function(relpath) {
            var extname = path.extname(relpath),
                dirname = path.dirname(relpath),
                basename = path.basename(relpath, extname),
                k = path.join(dirname, basename);

            // don't include the destination
            if (path.resolve(src, relpath) !== dest) {
                matches.push({
                    src: relpath,
                    basename: basename,
                    dirname: dirname,
                    extname: extname,
                    relpath: path.join(rel, dirname, basename)
                });
            }
        });

        // add some convenience props
        if (matches.length) {
            matches[0].isFirst = true;
            matches[matches.length-1].isLast = true;
        }

        return matches;
    }

    // custom task to generate a module that automatically registers all Handlebar partials
    grunt.registerTask('bundle:partials', 'Generates a module that automatically registers all Handlebar partials', function() {
        var src = 'src/templates/partials',
            dest = path.resolve('src/bundles/partials.js'),
            glob = ['**/*.hbs', '**/*.handlebar', '**/*.handlebars'],
            matches = bundler(src, dest, glob),
            output;

        output = Handlebars.compile([
            "// DO NOT EDIT! This file is automatically generated by running: grunt bundle:partials",
            "var Handlebars = require('hbsfy/runtime');",
            "{{#each this}}Handlebars.registerPartial('{{basename}}', require('./{{relpath}}{{extname}}'));\n{{/each}}"
        ].join('\n'))(matches);

        grunt.file.write(dest, output);
    });

    // custom task to generate a bundled view module
    grunt.registerTask('bundle:views', 'Generates a bundled view module', function() {
        var src = 'src/js/views',
            dest = path.resolve('src/bundles/views.js'),
            glob = '**/*.js',
            matches = bundler(src, dest, glob),
            output;

        output = Handlebars.compile([
            "// DO NOT EDIT! This file is automatically generated by running: grunt bundle:views",
            "module.exports = {",
            "{{#each this}}'{{basename}}': require('./{{relpath}}'){{#unless isLast}},\n{{/unless}}{{/each}}",
            "};"
        ].join('\n'))(matches);

        grunt.file.write(dest, output);
    });

    // run all bundle sub-tasks
    grunt.registerTask('bundle', [
        'bundle:partials',
        'bundle:views'
    ]);

};
